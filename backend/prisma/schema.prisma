generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PROJECT_MANAGER
  DEVELOPER
  DESIGNER
  QC
}

enum UserType {
  INHOUSE
  FREELANCER
}

enum ClientType {
  UPWORK
  DIRECT
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  COMPLETED
  BLOCKED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  NEEDS_CHANGES
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  RELEASED
  CANCELLED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  role          UserRole  @default(DEVELOPER)
  userType      UserType  @default(INHOUSE)
  avatar        String?
  phone         String?
  hourlyRate    Decimal?  @db.Decimal(10, 2)
  monthlySalary Decimal?  @db.Decimal(12, 2)  // Monthly salary in PKR
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignedTasks     Task[]         @relation("AssignedTasks")
  createdTasks      Task[]         @relation("CreatedTasks")
  reviewedTasks     Task[]         @relation("ReviewedTasks")
  timeEntries       TimeEntry[]
  projectMembers    ProjectMember[]
  activityLogs      ActivityLog[]
  notifications     Notification[]

  @@map("users")
}

model Client {
  id            String      @id @default(uuid())
  name          String
  email         String?
  phone         String?
  company       String?
  clientType    ClientType
  upworkProfile String?
  website       String?
  address       String?
  notes         String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  projects      Project[]

  @@map("clients")
}

model Project {
  id                String         @id @default(uuid())
  name              String
  description       String?
  clientId          String
  status            ProjectStatus  @default(PLANNING)
  startDate         DateTime?
  endDate           DateTime?
  budget            Decimal?       @db.Decimal(12, 2)  // Total assigned budget
  currency          String         @default("USD")
  platformFeePercent Decimal?      @db.Decimal(5, 2)   // Platform/service fee percentage (e.g., 10.00)
  workingBudget     Decimal?       @db.Decimal(12, 2)  // Budget allocated for execution
  exchangeRate      Decimal?       @db.Decimal(10, 4)  // Custom exchange rate to PKR
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  client        Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks         Task[]
  members       ProjectMember[]
  milestones    Milestone[]

  @@map("projects")
}

model Milestone {
  id          String          @id @default(uuid())
  projectId   String
  title       String
  description String?
  amount      Decimal         @db.Decimal(12, 2)  // Milestone amount
  currency    String          @default("USD")
  status      MilestoneStatus @default(PENDING)
  dueDate     DateTime?
  releasedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("milestones")
}

model ProjectMember {
  id          String   @id @default(uuid())
  projectId   String
  userId      String
  role        String   @default("developer")
  joinedAt    DateTime @default(now())

  // Relations
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Task {
  id              String        @id @default(uuid())
  title           String
  description     String?
  projectId       String
  assigneeId      String?
  createdById     String
  status          TaskStatus    @default(TODO)
  priority        TaskPriority  @default(MEDIUM)
  estimatedHours  Decimal?      @db.Decimal(6, 2)
  dueDate         DateTime?
  completedAt     DateTime?
  order           Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // QC Review fields
  reviewStatus    ReviewStatus?
  reviewComment   String?
  reviewedById    String?
  reviewedAt      DateTime?
  hasBugs         Boolean       @default(false)

  // Relations
  project         Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignee        User?         @relation("AssignedTasks", fields: [assigneeId], references: [id], onDelete: SetNull)
  createdBy       User          @relation("CreatedTasks", fields: [createdById], references: [id])
  reviewedBy      User?         @relation("ReviewedTasks", fields: [reviewedById], references: [id], onDelete: SetNull)
  timeEntries     TimeEntry[]
  comments        TaskComment[]

  @@map("tasks")
}

model TimeEntry {
  id          String    @id @default(uuid())
  taskId      String
  userId      String
  startTime   DateTime
  endTime     DateTime?
  duration    Int?      // Duration in seconds
  notes       String?
  isBillable  Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  task        Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

model TaskComment {
  id          String   @id @default(uuid())
  taskId      String
  userId      String
  content     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String
  action      String
  entityType  String
  entityId    String
  details     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  title       String
  message     String
  type        String
  isRead      Boolean  @default(false)
  data        Json?
  createdAt   DateTime @default(now())

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
